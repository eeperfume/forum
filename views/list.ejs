<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link href="/main.css" rel="stylesheet" />
  </head>

  <body class="grey-bg">
    <%- include('nav.ejs') %>
    <input class="search" />
    <button class="search-send">ê²€ìƒ‰</button>
    <script>
      document.querySelector(".search-send").addEventListener("click", () => {
        let searchValue = document.querySelector(".search").value;
        location.href = "/search?val=" + searchValue;
      });
    </script>
    <div class="white-bg">
      <% for (let data of datas) { %>
      <div class="list-box">
        <h4>
          <a href="/detail/<%= data._id %>"><%= data.title %></a>
          <a href="/edit/<%= data._id %>">âœï¸</a>
          <% if (JSON.stringify(data.user) == JSON.stringify(user._id)) { %>
          <span class="delete" data-id="<%= data._id %>">ğŸ—‘ï¸</span>
          <% } %>
        </h4>
        <p><%= data.content %></p>
      </div>
      <% } %>
    </div>
    <a href="/list/next/<%= datas[datas.length - 1]._id %>">ë‹¤ìŒ</a>
  </body>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    // fetch ì‚¬ìš© (í•˜ë‚˜ë§Œ)
    // console.log("<%= datas[0]._id %>");
    // document.querySelectorAll(".delete")[0].addEventListener("click", (e) => {
    //   // fetch("/delete?id=<%= datas[0]._id %>", {
    //   //   method: "DELETE",
    //   // });
    //   console.log(e.target.dataset.id);
    //   fetch("/delete?id=" + e.target.dataset.id, {
    //     method: "DELETE",
    //   }).then((resp) => {
    //     console.log(resp);
    //     // ì‚­ì œ ë²„íŠ¼ ëˆ„ë¥´ë©´ HTML ì½”ë“œë„ ê°™ì´ ì—†ì• ì¤˜, ì™œ ë°ì´í„°ë§Œ ì—†ì•°? ê·¸ëŸ¬ë‹ˆê¹Œ ìƒˆë¡œê³ ì¹¨í•´ì•¼ ì‚­ì œëœ ê²Œ ë³´ì´ì–ì•„
    //     console.log(e.target.parentElement.parentElement);
    //     e.target.parentElement.parentElement.remove();
    //   });
    // });
    // console.log(document.querySelectorAll(".delete"));

    // fetch ì‚¬ìš©
    // const datas = document.querySelectorAll(".delete");
    // for (data of datas) {
    //   // console.log(data);
    //   data.addEventListener("click", (e) => {
    //     // console.log(e.target.parentElement);
    //     // console.log(e.target.dataset.id);
    //     fetch("/delete?id=" + e.target.dataset.id, {
    //       method: "DELETE",
    //     })
    //       .then((resp) => {
    //         console.log(resp);
    //         if (!resp.ok) {
    //           // ì„œë²„ê°€ ì—ëŸ¬ ì½”ë“œ ì „ì†¡ ì‹œ ì‹¤í–‰í•  ì½”ë“œ
    //           throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${resp.status}`);
    //         }
    //         return resp.text(); // ì„œë²„ê°€ ë³´ë‚´ëŠ” ê²Œ ë¬¸ìì¸ ê²½ìš°
    //         // return resp.json(); // ì„œë²„ê°€ ë³´ë‚´ëŠ” ê²Œ array/objectì¸ ê²½ìš°
    //       })
    //       .then((resp) => {
    //         // ì„±ê³µ ì‹œ ì‹¤í–‰í•  ì½”ë“œ
    //         // ì‚­ì œ ë²„íŠ¼ ëˆ„ë¥´ë©´ HTML ì½”ë“œë„ ê°™ì´ ì—†ì• ì¤˜, ì™œ ë°ì´í„°ë§Œ ì—†ì•°? ê·¸ëŸ¬ë‹ˆê¹Œ ìƒˆë¡œê³ ì¹¨í•´ì•¼ ì‚­ì œëœ ê²Œ ë³´ì´ì–ì•„
    //         console.log(resp);
    //         // throw new Error("ì˜¤ë¥˜ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤.");
    //         // console.log(e.target.parentElement.parentElement);
    //         e.target.parentElement.parentElement.remove();
    //       })
    //       .catch((error) => {
    //         // ì‹¤íŒ¨ ì‹œ ì‹¤í–‰í•  ì½”ë“œ (ì¸í„°ë„· ë¬¸ì œ ë“±... ë‹¤ì–‘í•œ ì‚¬ìœ ë¡œ ì¸í•´ ë°œìƒí•  ìˆ˜ ìˆìŒ.)
    //         console.log(error); // ì˜¤ë¥˜ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤.
    //       });
    //   });
    // }

    // axios ì‚¬ìš©
    const datas = document.querySelectorAll(".delete");
    for (data of datas) {
      data.addEventListener("click", (e) => {
        axios
          .delete("/delete?id=" + e.target.dataset.id)
          .then((resp) => {
            console.log("axios ì¨ë³´ì!");
            console.log(resp.data); // resp.text() or resp.json()
            // throw new Error("ì˜¤ë¥˜ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤.");
            e.target.parentElement.parentElement.remove();
          })
          .catch((error) => {
            console.log("ì„œë²„ì—ì„œ ì˜¤ë¥˜ ë°œìƒí•¨");
            console.log(error); // ì˜¤ë¥˜ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤.
            alert(error.response.data);
          });
      });
    }
  </script>
</html>
